var loki=function(){"use strict";function t(t){this.filename=t||"loki.db",this.collections=[];var i=function(){return"undefined"!=typeof module&&module.exports?"NODEJS":void 0!==document?-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://")?"CORDOVA":"BROWSER":"CORDOVA"};this.ENV=i(),"NODEJS"===this.ENV&&(this.fs=require("fs"))}function i(t,i,e,n){this.name=t,this.data=[],this.indices={},this.idIndex={},this.objType=i||"",this.transactional=n||!1,this.cachedIndex=null,this.cachedData=null,this.maxId=0,this.Views={};for(var o=e||["id"],s=o.length;s--;)this.ensureIndex(o[s]);this.ensureIndex("id")}return t.prototype.addCollection=function(t,e,n,o){var s=new i(t,e,n,o);return this.collections.push(s),s},t.prototype.loadCollection=function(t){this.collections.push(t)},t.prototype.getCollection=function(t){var i,e=!1,n=this.collections.length;for(i=0;n>i;i+=1)if(this.collections[i].name===t)return e=!0,this.collections[i];if(!e)throw"No such collection"},t.prototype.listCollections=function(){for(var t=this.collections.length,i=[];t--;)i.push({name:this.collections[t].name,type:this.collections[t].objType,count:this.collections[t].data.length});return i},t.prototype.removeCollection=function(t){var i=0,e=this.collections.length;for(i;e>i;i+=1)if(this.collections[i].name===t){this.collections.splice(i,1);break}},t.prototype.getName=function(){return this.name},t.prototype.serialize=function(){return JSON.stringify(this)},t.prototype.toJson=t.prototype.serialize,t.prototype.loadJSON=function(t){var i,e,n,o,s=JSON.parse(t),a=0,r=s.collections.length;for(this.name=s.name,this.collections=[],a;r>a;a+=1){for(i=s.collections[a],e=this.addCollection(i.name,i.objType),n=i.data.length,o=0;n>o;o++)e.data[o]=i.data[o];e.maxId=0==i.data.length?0:i.data.maxId,e.indices=i.indices,e.idIndex=i.indices.id,e.transactional=i.transactional,e.ensureAllIndexes()}},t.prototype.loadDatabase=function(t){var i=t||function(){},e=this;"NODEJS"===this.ENV&&this.fs.readFile(this.filename,{encoding:"utf8"},function(t,n){if(t)throw t;e.loadJSON(n),i(n)})},t.prototype.saveToDisk=function(t){var i=t||function(){},e=this;"NODEJS"===this.ENV&&this.fs.exists(this.filename,function(t){t&&e.fs.unlink(e.filename),e.fs.writeFile(e.filename,e.serialize(),function(t){if(t)throw t;i()})})},t.prototype.save=t.prototype.saveToDisk,i.prototype.ensureIndex=function(t){if(null===t||void 0===t)throw"Attempting to set index without an associated property";var i,e=this.data.length,n=0;for(this.indices.hasOwnProperty(t)?i=this.indices[t]:(this.indices[t]=[],i=this.indices[t]),n;e>n;n+=1)i.push(this.data[n][t]);"id"===t&&(this.idIndex=i)},i.prototype.ensureIndexAsync=function(t,i){this.async(function(){this.ensureIndex(t)},i)},i.prototype.ensureAllIndexes=function(){for(var t=this.indices.length;t--;)this.ensureIndex(this.indices[t].name);0===t&&this.ensureIndex("id")},i.prototype.ensureAllIndexesAsync=function(t){this.async(function(){this.ensureAllIndexes()},t)},i.prototype.findAndUpdate=function(t,i){var e,n=this.view(t),o=0;try{for(o;o<n.length;o++)e=i(n[o]),this.update(e)}catch(s){this.rollback()}},i.prototype.insert=function(t){return t.id=null,t.objType=this.objType,this.add(t),t},i.prototype.clear=function(){this.data=[],this.indices={},this.idIndex={},this.cachedIndex=null,this.cachedData=null,this.maxId=0,this.Views={}},i.prototype.update=function(t){if(!t.hasOwnProperty("id"))throw"Trying to update unsynced document. Please save the document first by using add() or addMany()";try{this.startTransaction();var i,e=this.get(t.id,!0),n=e[0],o=e[1];this.data[o]=t;for(i in this.indices)this.indices.hasOwnProperty(i)&&(this.indices[i][o]=n[i]);this.commit()}catch(s){this.rollback()}},i.prototype.add=function(t){if("object"!=typeof t)throw"Object being added needs to be an object";if(""===this.objType&&0===this.data.length)this.objType=t.objType;else{if(this.objType!==t.objType)throw"Object type ["+t.objType+"] is incongruent with collection type ["+this.objType+"]";if(""===this.objType)throw"Object is not a model";if(null!==t.id&&t.id>0)throw"Document is already in collection, please use update()";try{this.startTransaction(),this.maxId++;var i;isNaN(this.maxId)&&(this.maxId=this.data[this.data.length-1].id+1),t.id=this.maxId,this.data.push(t);for(i in this.indices)this.indices.hasOwnProperty(i)&&this.indices[i].push(t[i]);return this.commit(),t}catch(e){this.rollback()}}},i.prototype.addMany=function(){for(var t=arguments.length;t--;)this.add(arguments[t])},i.prototype.remove=function(t){if("object"!=typeof t)throw"Parameter is not an object";if(!t.hasOwnProperty("id"))throw"Object is not a document stored in the collection";try{this.startTransaction();var i,e=this.get(t.id,!0),n=e[1];this.data.splice(n,1);for(i in this.indices)this.indices.hasOwnProperty(i)&&this.indices[i].splice(n,1);this.commit()}catch(o){this.rollback()}},i.prototype.get=function(t,i){var e=i||!1,n=this.indices.id,o=n.length-1,s=0,a=Math.floor(s+(o-s)/2);if(isNaN(t)&&(t=parseInt(t),isNaN(t)))throw"Passed id is not an integer";for(;n[s]<n[o];)a=Math.floor((s+o)/2),n[a]<t?s=a+1:o=a;return o===s&&n[s]===t?e?[this.data[s],s]:this.data[s]:null},i.prototype.findOne=function(t,i){var e,n,o=!1,s=null,a=this.indices.length;for(a in this.indices)if(this.indices.hasOwnProperty(a)&&a===t){o=!0,s=this.indices[a];break}if(!o)return this.findOneUnindexed(t,i);for(e=s.data.length;e--;)if(s.data[e]===i)return n=this.data[e];return null},i.prototype.find=function(t){function i(t,i){return t===i}function e(t,i){return t>i}function n(t,i){return t>=i}function o(t,i){return i>t}function s(t,i){return i>=t}function a(t,i){return t!==i}var r,h,c,d,l,u,f,p,y=t||"getAll",m={$eq:i,$gt:e,$gte:n,$lt:o,$lte:s,$ne:a},w=!1,g=null,x=[];if("getAll"===y)return this.data;for(d in y)if(y.hasOwnProperty(d)){if(r=d,"object"!=typeof y[d])c="$eq",h=y[d];else{if("object"!=typeof y[d])throw"Do not know what you want to do.";for(l in y[d])y[d].hasOwnProperty(l)&&(c=l,h=y[d][l])}break}if(null===this.data)throw new TypeError;if(this.indices.hasOwnProperty(r)&&(w=!0,g=this.indices[r]),u=m[c],w)for(f=g,p=f.length;p--;)u(f[p],h)&&x.push(this.data[p]);else for(f=this.data,p=f.length;p--;)u(f[p][r],h)&&x.push(f[p]);return x},i.prototype.findOneUnindexed=function(t,i){for(var e,n=this.data.length;n--;)if(this.data[n][t]===i)return e=this.data[n];return null},i.prototype.rollback=function(){this.transactional&&null!==this.cachedData&&null!==this.cachedIndex&&(this.data=this.cachedData,this.indices=this.cachedIndex)},i.prototype.startTransaction=function(){this.transactional&&(this.cachedData=this.data,this.cachedIndex=this.indices)},i.prototype.commit=function(){this.transactional&&(this.cachedData=null,this.cachedIndex=null)},i.prototype.async=function(t,i){setTimeout(function(){if("function"!=typeof t)throw"Argument passed for async execution is not a function";t(),i()},0)},i.prototype.view=function(t){var i,e=[],n=this.data.length;if("string"==typeof t&&"function"==typeof this.Views[t])i=this.Views[t];else{if("function"!=typeof t)throw"Argument is not a stored view or a function";i=t}try{for(;n--;)i(this.data[n])===!0&&(e[n]=this.data[n]);return e}catch(o){throw o}},i.prototype.storeView=function(t,i){"function"==typeof i&&(this.Views[t]=i)},i.prototype.mapReduce=function(t,i){try{return i(this.data.map(t))}catch(e){throw e}},i.prototype.no_op=function(){},t}();"undefined"!=typeof module&&module.exports&&(module.exports=loki);